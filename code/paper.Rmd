---
title: "Community Data Science meets Digital Heritage: Controversies about World Heritage Sites in the Online Community of Wikipedia"
---

Load the data

```{r}
library(tidyverse)

# load the random pages
ten_k_random_wp_pages <- readRDS(here::here("data", "random_page_data_tbl.rds"))

# load the random pages revision histories
ten_k_random_wp_pages_lst <- readRDS(here::here("data", "random_page_data_lst.rds"))

# all WH sites with WP pages (n = 584)
page_data_for_all_pages <- 
  readRDS(here::here("data", 
                     "page_data_for_all_pages.rds"))

# all WH sites, with and without WP pages (n = 846)
wh_wiki_table <- 
  read_csv(here::here("data", 
                      "wh_wiki_table.csv"))

# all WH sites according to UNESCO
# from https://whc.unesco.org/en/syndication
wh_unesco <- readxl::read_excel(here::here("data",
                                           "whc-sites-2018.xls")) %>% 
  filter(category %in% c("Cultural", "Mixed"))

library("rnaturalearth")
library("rnaturalearthdata")
world <- ne_countries(scale = "medium", returnclass = "sf")

# functions used more than once:

estimate_mode <- function(x) {
  d <- density(x)
  d$x[which.max(d$y)]
}

theme_nogrid <- function (base_size = 12, base_family = "") {
  theme_bw(base_size = base_size, 
           base_family = base_family) %+replace% 
    theme(panel.grid = element_blank() )   
}
```

## Representation by country

Where are the WH sites, before looking into WP

```{r}

wh_unesco_countries <- 
wh_unesco %>% 
  separate_rows(states_name_en, convert = TRUE, sep = ",") %>% 
  mutate(country = case_when(
    states_name_en == "Bolivia (Plurinational State of)"  ~ "Bolivia",
    states_name_en == "Cabo Verde"  ~ "Republic of Cabo Verde",
    states_name_en == "Czechia"  ~ "Czech Republic",
    states_name_en == "Democratic People's Republic of Korea"  ~ "Republic of Korea",
    states_name_en == "Gambia (the)"  ~ "The Gambia",
    states_name_en == "Holy See"  ~ "Vatican",
    states_name_en == "Iran (Islamic Republic of)"  ~ "Iran",
    states_name_en == "Lao People's Democratic Republic"  ~ "Lao PDR",
    states_name_en == "Micronesia (Federated States of)"  ~ "Federated States of Micronesia",
    states_name_en == "Syrian Arab Republic"  ~ "Syria",
    states_name_en == "the former Yugoslav Republic of Macedonia"  ~ "Macedonia",
    states_name_en == "United Kingdom of Great Britain and Northern Ireland"  ~ "United Kingdom",
    states_name_en == "United Republic of Tanzania"  ~ "Tanzania",
    states_name_en == "United States of America"  ~ "United States",
    states_name_en == "Venezuela (Bolivarian Republic of)"  ~ "Venezuela",
    states_name_en == "United States of America"  ~ "United States",
    states_name_en == "Viet Nam"  ~ "Vietnam",
    states_name_en == "Republic of Moldova"  ~ "Moldova",
    TRUE ~ as.character(states_name_en)
  ))

wh_unesco_countries_count <-  
  wh_unesco_countries %>% 
  count(country)

median_number_unesco_sites_per_country <- 
  median(wh_unesco_countries_count$n)

mode_number_unesco_sites_per_country <- 
  round(estimate_mode(wh_unesco_countries_count$n), 1)

wh_unesco_country_counts_hist <- 
ggplot(wh_unesco_countries_count,
       aes(n)) +
  geom_histogram() +
  annotate("text", x = 30, y = 30, 
           label = str_glue('Median = {median_number_unesco_sites_per_country} WH sites/country\nMode = {mode_number_unesco_sites_per_country} WH sites/country'),
           size = 3) +
  theme_nogrid(12)

sf_map_data_unesco <- 
world %>% 
  left_join(wh_unesco_countries_count,
            by = c( 'name_long' = 'country')) %>% 
  select(name, n, geometry) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  filter(name != "Antartica")

wh_country_unesco_count_map <- 
ggplot(data = sf_map_data_unesco) +
    geom_sf(aes(fill = n), lwd = 0) +
    scale_fill_viridis_c(na.value="grey90") +
  coord_sf() +
  coord_sf(ylim = c(-50, 90), datum = NA) +
  theme_minimal()

wh_country_unesco_count_map +
  annotation_custom(ggplotGrob(wh_unesco_country_counts_hist), 
                    xmin = -190, 
                    xmax = -90, 
                    ymin= 10, 
                    ymax=-70) 

```

What countries are most represented?

```{r}
  # get country of site from location text
  # Laos, Czech Republic, Micronesia, Zimbabwe, South Sudan, Chad, 
  # Central African Republic, Congo, Gabon, Cameroon, Nigeria, Bosnia and Herzegovina
  #  Cote d'Ivoire, Sierra Leone, Guyana, Belize, 
  country_names <-  paste(c(world$name, 
                            "United States",
                            "Czech Republic",
                             "Antigua & Barbuda",
                            "Saint Kitts and Nevis"
                            ),
                          collapse="|")

  page_data_for_all_pages_location <- 
    page_data_for_all_pages %>% 
    mutate(country = str_extract(Location, 
                                 regex(country_names, 
                                       ignore.case=TRUE))) %>% 
    mutate(country = case_when(
      country == "United States" ~ "United States of America",
      country == "Czech Republic" ~ "Czechia",
      country == "Antigua & Barbuda" ~ "Antigua and Barb.",
      country == "Saint Kitts and Nevis" ~ "St. Kitts and Nevis",
      TRUE ~ as.character(country)))
  
  
wh_wiki_table_location <- 
  wh_wiki_table %>% 
  mutate(country = str_extract(Location, 
                                 regex(country_names, 
                                       ignore.case=TRUE))) %>% 
    mutate(country = case_when(
      country == "United States" ~ "United States of America",
      country == "Czech Republic" ~ "Czechia",
      country == "Antigua & Barbuda" ~ "Antigua and Barb.",
      country == "Saint Kitts and Nevis" ~ "St. Kitts and Nevis",
      TRUE ~ as.character(country)))
  
```


```{r}

wh_wk_country_counts <- 
page_data_for_all_pages_location %>% 
  count(country) %>% 
  filter(!is.na(country))

theme_nogrid <- function (base_size = 12, base_family = "") {
  theme_bw(base_size = base_size, 
           base_family = base_family) %+replace% 
    theme(panel.grid = element_blank() )   
}

median_number_wp_pages_per_country <- 
  median(wh_wk_country_counts$n)

estimate_mode <- function(x) {
  d <- density(x)
  d$x[which.max(d$y)]
}

mode_number_wp_pages_per_country <- 
  round(estimate_mode(wh_wk_country_counts$n), 1)

wh_wk_country_counts_hist <- 
ggplot(wh_wk_country_counts,
       aes(n)) +
  geom_histogram() +
  annotate("text", x = 15, y = 30, 
           label = str_glue('Median = {median_number_wp_pages_per_country} WP pages/country\nMode = {mode_number_wp_pages_per_country} WP pages/country'),
           size = 2) +
  theme_nogrid(12)

wh_wk_country_counts_bar <- 
ggplot(wh_wk_country_counts,
       aes(reorder(country, n),
           n)) +
  geom_col() +
  coord_flip() +
  theme_minimal(base_size = 6) +
  xlab("")
```

Here's a map of countries showing which has the most WP pages for WH sites

```{r}
sf_map_data <- 
world %>% 
  left_join(wh_wk_country_counts,
            by = c( 'name' = 'country')) %>% 
  select(name, n, geometry) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  filter(name != "Antartica")

wh_wk_country_count_map <- 
ggplot(data = sf_map_data) +
    geom_sf(aes(fill = n), lwd = 0) +
    scale_fill_viridis_c(na.value="grey90") +
  coord_sf() +
  coord_sf(ylim = c(-50, 90), datum = NA) +
  theme_minimal()

wh_wk_country_count_map +
  annotation_custom(ggplotGrob(wh_wk_country_counts_hist), 
                    xmin = -190, 
                    xmax = -90, 
                    ymin= 10, 
                    ymax=-70) 
```

Map of the ratio of WH sites with WP pages, per country

```{r}
wh_wiki_table_location_prop <- 
wh_wiki_table_location %>% 
  mutate(has_wp_page = ifelse(!is.na(site_page_name), 1, 0)) %>% 
  group_by(country) %>% 
  summarise(prop_sites_with_pages = sum(has_wp_page) / n()) %>% 
  filter(!is.na(country))

wh_wk_country_prop_hist <- 
ggplot(wh_wiki_table_location_prop,
       aes(prop_sites_with_pages)) +
  geom_histogram() +
  theme_nogrid(10)

wh_wk_country_all_counts <- 
wh_wiki_table_location %>% 
  count(country) %>% 
  filter(!is.na(country)) %>% 
  left_join(wh_wiki_table_location_prop)

wh_wk_country_prop_scatter <- 
ggplot(wh_wk_country_all_counts,
       aes(prop_sites_with_pages, n)) +
  geom_point(alpha = 0.5) +
  coord_fixed(0.02) +
  theme_nogrid(6)

wh_wk_country_prop_scatter_marginal <- 
ggExtra::ggMarginal(wh_wk_country_prop_scatter,
                    type = "histogram")

sf_map_data_prop <- 
world %>% 
  filter(name != "Antartica") %>% 
  left_join(wh_wiki_table_location_prop,
            by = c( 'name' = 'country')) %>% 
  select(name, 
         prop_sites_with_pages, 
         geometry)  %>% 
  mutate(prop_sites_with_pages = ifelse(is.na(prop_sites_with_pages), 0, prop_sites_with_pages))

wh_wk_country_prop_map <- 
ggplot(data = sf_map_data_prop) +
    geom_sf(aes(fill = prop_sites_with_pages), lwd = 0) +
    scale_fill_viridis_c(na.value="grey90") +
  coord_sf() +
  coord_sf(ylim = c(-50, 90), datum = NA) +
  theme_minimal()

wh_wk_country_prop_map +
  annotation_custom((wh_wk_country_prop_scatter_marginal), 
                    xmin = -190, 
                    xmax = -90, 
                    ymin= 10, 
                    ymax=-70) 
```


## Basic qualities of the WP articles about WH sites

```{r}
ten_k_random_wp_pages_basic_qualities <- 
ten_k_random_wp_pages %>% 
  select(page_wordcount,
         page_wikilinks_out, 
         page_cited_items_on) %>% 
  mutate(rnd_page_wikilinks_out_per_1k_words = page_wikilinks_out / page_wordcount * 1000,
         rnd_page_cited_items_on_per_1k_words = page_cited_items_on / page_wordcount * 1000,
         rnd_page_wordcount = page_wordcount) %>% 
  select(-page_wikilinks_out,
         -page_cited_items_on,
         -page_wordcount) 

ten_k_random_wp_pages_basic_qualities_long <- 
  ten_k_random_wp_pages_basic_qualities %>% 
  gather(variable, value) 
```


Length: correlate with ??
number of links out/word
number of references/word: scholarly or not

```{r}
page_data_for_all_pages_basic_qualities <- 
page_data_for_all_pages %>% 
  select(page_wordcount,
         page_wikilinks_out, 
         page_cited_items_on) %>% 
  mutate(page_wikilinks_out_per_1k_words = page_wikilinks_out / page_wordcount * 1000,
         page_cited_items_on_per_1k_words = page_cited_items_on / page_wordcount * 1000) %>% 
  select(-page_wikilinks_out,
         -page_cited_items_on)

page_data_for_all_pages_basic_qualities_long <- 
page_data_for_all_pages_basic_qualities %>% 
  gather(variable, value) %>% 
  bind_rows(ten_k_random_wp_pages_basic_qualities_long) %>% 
  mutate(source = ifelse(str_detect(variable, "rnd" ), "10k Random pages", "World Heritage pages")) %>% 
  mutate(variable = str_remove(variable, "rnd_"))

# density plots
  ggplot(page_data_for_all_pages_basic_qualities_long,
         aes(value)) +
  geom_density(aes(fill = source),
               alpha = 0.3) +
  scale_x_log10() +
  scale_fill_viridis_d() +
  facet_wrap( ~ variable, 
              scales = "free") +
  theme_minimal()
```

```{r}
# scatterplots
  ggplot() +
      geom_point(data = ten_k_random_wp_pages_basic_qualities,
             aes(rnd_page_wikilinks_out_per_1k_words,
                 rnd_page_cited_items_on_per_1k_words,
                 size = rnd_page_wordcount),
             colour = "grey80",
             alpha = 0.4) +
  geom_point(data = page_data_for_all_pages_basic_qualities,
             aes(page_wikilinks_out_per_1k_words,
                 page_cited_items_on_per_1k_words,
                 size = page_wordcount),
             colour = "red",
             alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  scale_fill_viridis_d() +
  coord_fixed() +
  theme_minimal()

```

## Basic qualitites of attention paid to articles

number of links in
page_views_last_n_days_total

```{r}
ten_k_random_wp_pages_attent <- 
ten_k_random_wp_pages %>% 
  select(page_wikilinks_in, 
         page_views_last_n_days_total) 

page_data_for_all_pages_attent <- 
page_data_for_all_pages %>% 
  select(page_wikilinks_in, 
         page_views_last_n_days_total) 

page_data_for_all_pages %>% 
  select( Site,
         page_wikilinks_in, 
         page_views_last_n_days_total)  %>% 
  ggplot(aes(page_wikilinks_in,
             page_views_last_n_days_total,
             label = Site)) +
  geom_point(alpha = 0.4) +
    geom_text_repel(
    data          = page_data_for_all_pages %>%  
                      filter(page_views_last_n_days_total > 190000),
    segment.size  = 0.2,
    segment.color = "grey50",
    direction     = "both"
  ) +
  scale_y_log10(expand = c(1, 0.05)) +
  scale_x_log10(limits = c(1, 10000)) +
  coord_fixed(0.5) +
  theme_minimal() 

page_data_for_all_pages_attent_long <- 
page_data_for_all_pages_attent %>% 
  gather(variable, value) %>% 
  bind_rows(ten_k_random_wp_pages_attent %>% 
              gather(variable, value) %>% 
              mutate(variable =  str_glue('rnd_{variable}'))) %>% 
  mutate(source = ifelse(str_detect(variable, "rnd" ), "10k Random pages", 
                         "World Heritage pages")) %>% 
  mutate(variable = str_remove(variable, "rnd_"))

# density plots
  ggplot(page_data_for_all_pages_attent_long,
         aes(value)) +
  geom_density(aes(fill = source),
               alpha = 0.3) +
  scale_x_log10() +
  scale_fill_viridis_d() +
  facet_wrap( ~ variable, 
              scales = "free") +
  theme_minimal()
```

## Basic qualities of the editing process

number of edits, total, prop/words
size of edits
divesity of editors

```{r}
revision_history_page_details <- 
  tibble(revision_history_page_details = map(page_data_for_all_pages$page_info_t, 
      ~.x$revision_history_page_details)) %>% 
  mutate(Site =         page_data_for_all_pages$Site,
         Country =      page_data_for_all_pages$country,
         rh_n_editors = map_int(revision_history_page_details, ~n_distinct(.x$rh_user)),
         rh_n_edits =   map_int(revision_history_page_details, ~nrow(.x)),
         rh_user_simpson_idx = page_data_for_all_pages$rh_user_simpson_idx,
         rh_user_bot_prop = page_data_for_all_pages$rh_user_bot_prop,
         rh_revert_prop = page_data_for_all_pages$rh_revert_prop)

ggplot(revision_history_page_details,
       aes(rh_n_edits)) +
  geom_histogram()

```


## Locality  

IP addresses

```{r}

get_ip_addresses <- function(x){
  re <- regexpr(
  "(?(?=.*?(\\d+\\.\\d+\\.\\d+\\.\\d+).*?)(\\1|))", 
  x, perl = TRUE)
regmatches(x, re)
}

# get locations from IP addresses
library(rgeolocate)
ip_db <- system.file("extdata","GeoLite2-Country.mmdb", package = "rgeolocate")

revision_history_page_details_ip_addresses <- 
revision_history_page_details %>% 
  mutate(edits_from_ip_addresses = map(revision_history_page_details,
                          ~.x %>% 
                            filter(get_ip_addresses(rh_user) != "") %>% 
                            mutate(ip_location = map(rh_user, 
                                                     ~maxmind(.x, ip_db)))  %>% 
                            unnest(ip_location))) 


# analyse the countries of IP address vs country of WH site
revision_history_page_details_ip_addresses_df <- 
revision_history_page_details_ip_addresses %>% 
  unnest(edits_from_ip_addresses) 

revision_history_page_details_ip_addresses_countries <- 
revision_history_page_details_ip_addresses_df %>% 
  select(Site, Country, country_name, rh_n_edits ) %>% 
  filter_all(all_vars(!is.na(.))) %>% 
  group_by(Site, Country, rh_n_edits) %>% 
  count(country_name) %>% 
  mutate(prop_anon_of_all_edits = n / rh_n_edits) %>% 
  mutate(internal_edits = ifelse(Country ==  country_name, 
                                 TRUE, FALSE),
         n_anon_edits_total = n) %>% 
  left_join(revision_history_page_details_ip_addresses_df) %>% 
  distinct(Site,  
           Country, 
           prop_anon_of_all_edits, 
           internal_edits,
           .keep_all = TRUE) %>% 
  group_by(Site,  Country) %>% 
  summarise(sum_prop_internal = sum(n_anon_edits_total[internal_edits]) / sum(n_anon_edits_total),
            sum_prop_external = 1 - sum_prop_internal,
            rh_n_edits = unique(rh_n_edits),
            rh_n_edits_anon = sum(n_anon_edits_total),
            prop_anon_of_all_edits = sum(n) / rh_n_edits)
```


```{r}
# Histogram of proportion of anonymous edits 
# TODO and random sites
ggplot(revision_history_page_details_ip_addresses_countries,
       aes(prop_anon_of_all_edits)) +
  geom_histogram() +
  theme_minimal()
```

```{r}
# Histogram of proportion of all anonymous edits that come from same country as WH site
ggplot(revision_history_page_details_ip_addresses_countries,
       aes(sum_prop_internal)) +
  geom_histogram() +
  theme_minimal() 
```


```{r}
ggplot(revision_history_page_details_ip_addresses_countries,
       aes(sum_prop_internal,
           prop_anon_of_all_edits)) +
  geom_point() +
  theme_minimal() +
  coord_equal()

```




ggplot(revision_history_page_details_ip_addresses_countries, 
       aes(sum_prop_internal, 
           prop_anon_of_all_edits)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal()


```




## Networks

editors

## Controversies

time between edits
edit reverts
talk page: length and sentiment

## Technicity

bots



  - length of articles http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.451.4208&rep=rep1&type=pdf 
  - edit history to identify: diversity of contributions, 
  - reverts in edits for spotting contentious topics https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0038869 http://www.contropedia.net/  http://wwm.phy.bme.hu/ 
    - vandalism traces in edit history
  - talk page length
  - number of links in each page
  - page views: https://www.sciencedirect.com/science/article/abs/pii/S0006320716301240 
  - timing of edits: political events? Brexit?
    - citations in articles: https://arxiv.org/abs/0705.2106
  - are the citations scholarly? Archaeological? Meskell?
    - citations to these articles: https://www.tandfonline.com/doi/full/10.1080/0194262X.2016.1206052 
  - network analysis of editors, clusters of editors
  - sentiment analysis of talk pages
  - geolocation of anon editors by IP address
  - bots and technicity https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0171774 but see https://dl.acm.org/citation.cfm?id=3134684 
  
  - Compare to 10000 random Wikipedia sites
  - Compare to WH sites in media & academic literature
  